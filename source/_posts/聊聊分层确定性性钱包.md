---
title: 聊聊分层确定性钱包
date: 2020-03-08 14:30:55
tags: [比特币,冷钱包,HD钱包,分层确定性钱包]
---

上一次聊到区块链硬件钱包，没有想象中那么高科技，其实就是保存一组助记词，今天来聊一下分层确定性钱包。

现在市面上的钱包，在你注册时候会让你选
- 云端钱包
后台帮你随机一组助记词，跟你注册账号对应起来，这种方式对新手比较友好，无需了解助记词相关知识，缺点就是秘钥掌握在人家手里，这也是交易所的做法。
- HD钱包
也叫分层确定性钱包，即导入你自己的助记词，然后推导出，生成钱包私钥。

那助记词怎么就能导出私钥呢，我一组助记词，既能导出BTC私钥，又能导出ETH私钥？

是可以的，这是一个公开的协议（BIP44)。

BIP44指定了包含5个预定义树状层级的结构：

m / purpose' / coin_type' / account' / change / address_index

第一层的"purpose"总是被设定为44'。

第二层的“coin_type”特指加密货币的类型，每个币种都有自己的定义，如BTC就是'0'（毫无因为的C位）。

第三层的“account”，这可以允许使用者为了会计或者组织目的，而去再细分他们的钱包到独立的逻辑性亚账户。举个例子，一个HD钱包可能包含两个比特币“账户”：m/44'/0'/0' 和 m/44'/0'/1'。每个账户都是它自己亚树的根。

第四层的“change”。每一个HD钱包有两个亚树，一个是用来接收地址一个是用来创造找零地址。注意无论先前的层级是否使用是否使用强化衍生，这一层级使用的都是常规衍生。这是为了允许这一层级的树可以在可供不安全环境下，输出扩展的公共钥匙。

被HD钱包衍生的可用的地址是第四层级的子级，就是第五层级的树的“address_index”。比如，第三个层级的主账户收到比特币支付的地址就是 M/44'/0'/0'/0/2。

BIP44并不是所有钱包都会支持，因为早期加密货币野蛮生长，协议是后来定的，所以为了钱包之间的兼容性，要求用户输入完助记词之后，还会要求输入路径，这个路径，就可以推导出一对公私钥对。

接下来聊一下是怎么推导出来的，

* 生成（导入）一组助记词（BIP39 mnemonic code）。

* 助记词使用PBKDF2转化为种子。

* 种子通过使用HMAC-SHA512生成主私钥+主链码。

热钱包一般将主私钥跟助记词短语一起保存，也就是说拿到主私钥，还要需要知道助记词短语，才能使用主私钥，如果热钱包嫌麻烦，使用默认的助记词短语，那你的主私钥就危险了。

子公钥的派生

首先理解几个概念：

根据椭圆曲线的特性，私钥可以推导出公钥，但是公钥不能推导出私钥，

一个密钥，一个链码以及想要的子密钥的索引，就可以得到子私钥。

当然，子私钥，父链码，反过来也可以推导出父私钥。

所以在APP这一端，绝对不能碰私钥的，只能碰公钥。

那母公钥也是可以推导出子公钥？可以的。

这也是冷钱包业界常用的做法：私钥只在冷钱包里派生，公钥在APP端派生。要签名的时候再把数据传给冷钱包用私钥签名，这就是冷钱包为什么安全的根本原因。

母公钥如何推导出子公钥，秘诀就是强化衍生，它使用母私钥去推导子链码，而不是母公钥，具体细节就不讲了（我也理解不深），只要记住，有了这个技术，再也不能从子公钥推导出母私钥了，表现就是上面路径中右上角的<b>‘</b>。而且，为了避免了推导出主密钥，主密钥所衍生的第一层级的子密钥最好使用强化衍生。

最后再回过头来为什么叫分层确定性钱包。

分层不用讲，就是逐级派生子秘钥。

确定，我想包含两层意思，一层就是约定，每一级的含义，只要大家约定好了，就能派生出一个确定的钱包，另外一层意思就是根据每一级的索引，同一组助记词，总能派生出一对确定的公私钥对。

下次聊聊现在市面上几款常见的钱包。

以上。
